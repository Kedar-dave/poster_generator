{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <h1>Your Creative Studio</h1>
    <p style="color: var(--text-muted)">Generate amazing movie posters with AI</p>
</div>

<div class="generate-section">
    <form action="{{ url_for('generate') }}" method="POST" class="generate-form" onsubmit="showLoading()">
        <input type="text" name="prompt" class="form-input generate-input"
            placeholder="Describe your movie poster (e.g. 'A cyberpunk detective in a rainy neon city')" required>
        <button type="submit" class="btn btn-primary">Generate</button>
    </form>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; flex-direction: column;">
    <div
        style="width: 50px; height: 50px; border: 5px solid #334155; border-top: 5px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite;">
    </div>
    <p style="color: white; margin-top: 20px; font-size: 1.2rem;">Generating your masterpiece...</p>
</div>

<script>
    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }
</script>

<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<div class="posters-grid">
    {% for poster in posters %}
    <div class="poster-card">
        <div class="poster-image-container">
            {% if poster.locked %}
            <div class="poster-overlay" style="background: #1e293b; display: flex;">
                <div class="lock-icon">ðŸ”’</div>
                <span style="color: var(--text-muted)">Premium Content</span>
            </div>
            {% else %}
            <img src="{{ poster.poster_url }}" alt="Generated Poster" class="poster-image">
            {% endif %}
        </div>

        <div class="poster-info">
            <p class="poster-prompt" title="{{ poster.prompt_used }}">{{ poster.prompt_used }}</p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <span class="poster-date">{{ poster.timestamp[:10] }}</span>
                {% if poster.locked %}
                <button type="button" class="btn btn-primary" style="padding: 5px 15px; font-size: 0.8rem;"
                    onclick="openPaymentModal('{{ poster.prompt_used }}')">Unlock</button>
                {% else %}
                <a href="{{ poster.poster_url }}" target="_blank" class="btn btn-outline"
                    style="padding: 5px 15px; font-size: 0.8rem;">Download</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">
        <p>No posters generated yet. Try creating one above!</p>
    </div>
    {% endfor %}
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2 style="margin-bottom: 20px;">Unlock Poster</h2>
        <p style="margin-bottom: 20px; color: var(--text-muted);">Enter your payment details to unlock this masterpiece
            for $5.00</p>

        <form id="paymentForm" action="{{ url_for('unlock') }}" method="POST" onsubmit="return validatePayment()">
            <input type="hidden" id="paymentPrompt" name="prompt_used" value="">

            <div class="form-group">
                <label class="form-label">Card Number</label>
                <input type="text" class="form-input" placeholder="0000 0000 0000 0000" maxlength="19" required>
            </div>

            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Expiry</label>
                    <input type="text" class="form-input" placeholder="MM/YY" maxlength="5" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">CVV</label>
                    <input type="text" class="form-input" placeholder="123" maxlength="3" required>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-outline" onclick="closePaymentModal()"
                    style="flex: 1;">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Pay & Unlock</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openPaymentModal(prompt) {
        document.getElementById('paymentPrompt').value = prompt;
        document.getElementById('paymentModal').style.display = 'flex';
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').style.display = 'none';
    }

    function validatePayment() {
        // Mock validation - just checking if fields are filled (handled by required attribute)
        // In a real app, we'd validate the card number format, etc.
        // Show loading state
        const btn = document.querySelector('#paymentForm button[type="submit"]');
        btn.innerHTML = 'Processing...';
        btn.disabled = true;
        return true;
    }

    // Close modal if clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('paymentModal');
        if (event.target == modal) {
            closePaymentModal();
        }
    }
</script>
{% endblock %}